#!/usr/bin/env bash

set -e
# set -x

if [[ $1 = "" || ($1 = "new" && $2 = "") ]]; then
    echo "Usage: simplestack new <app_name>"
    echo "   or: simplestack <make-target> # see app_files/Makefile"
    exit 1
fi

SIMPLE_STACK_COMMAND=$1
shift
SIMPLE_STACK_ARGS=$@
APP_NAME=${SIMPLE_STACK_ARGS%% *}
SOURCE_ABS_PATH=$(greadlink -f ${BASH_SOURCE[0]})
SIMPLE_STACK_PATH=$(cd "$(dirname "${SOURCE_ABS_PATH}")" && cd .. && pwd)

echo "Creating application ${APP_NAME} from SimpleStack template..."
docker build -f ${SIMPLE_STACK_PATH}/Dockerfile.rails -t simplestack/rails .
docker run -it -v "$(PWD):/app" -v "${SIMPLE_STACK_PATH}:/simplestack" simplestack/rails rails new --skip-spring --skip-sprockets --database=postgresql -m /simplestack/template.rb ${SIMPLE_STACK_ARGS}

cd ${APP_NAME}

echo "Creating initial commit..."
echo "ruby" >> .gitignore
echo "vendor" >> .gitignore
git add .
git commit -m 'Initial commit'

echo "Your SimpleStack app ${APP_NAME} has been generated"
