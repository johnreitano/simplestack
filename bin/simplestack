#!/usr/bin/env bash

set -e
set -x

if [[ $1 = "" ]]; then
    echo "Usage: simplestack new <app_name>"
    exit 1
fi

SIMPLE_STACK_ARGS=$@
APP_NAME=${SIMPLE_STACK_ARGS%% *}
SOURCE=$(greadlink -f ${BASH_SOURCE[0]})
SIMPLE_STACK_PATH=$(cd "$(dirname "${SOURCE}")" && cd .. && pwd)

echo "Creating application ${APP_NAME} from SimpleStack template..."
rm -rf .simplestack-files/*
mkdir -p .simplestack-files
cp -R ${SIMPLE_STACK_PATH}/template.rb ${SIMPLE_STACK_PATH}/app_files .simplestack-files/

docker build -f ${SIMPLE_STACK_PATH}/Dockerfile.rails -t simplestack/rails .
docker run -it -v "$(PWD):/app" simplestack/rails rails new --skip-spring --skip-sprockets --database=postgresql -m .simplestack-files/template.rb ${SIMPLE_STACK_ARGS}

rm -rf .simplestack-files

cd ${APP_NAME}
make setup